//
//  RadioView.m
//  mia
//
//  Created by linyehui on 2015/09/09.
//  Copyright (c) 2015å¹´ Mia Music. All rights reserved.
//

#import "RadioView.h"
#import <AVFoundation/AVFoundation.h>
#import <MediaPlayer/MediaPlayer.h>
#import "UIImage+ColorToImage.h"
#import "MIAButton.h"
#import "MIALabel.h"
#import "MusicPlayerMgr.h"
#import "ShareListMgr.h"
#import "MiaAPIHelper.h"
#import "WebSocketMgr.h"
#import "ShareItem.h"
#import "LoopPlayerView.h"
#import "UserSession.h"
#import "LoginViewController.h"

static const CGFloat kPlayerMarginTop			= 90;
static const CGFloat kPlayerHeight				= 300;

static const CGFloat kFavoriteMarginBottom 		= 80;
static const CGFloat kFavoriteWidth 			= 25;
static const CGFloat kFavoriteHeight 			= 25;

@interface RadioView () <LoopPlayerViewDelegate>

@end

@implementation RadioView {
	ShareListMgr 	*_shareListMgr;
	LoopPlayerView	*_loopPlayerView;
	MIAButton		*_favoriteButton;
	MIALabel		*_commentLabel;
	MIALabel		*_viewsLabel;
	MIALabel		*_locationLabel;
	NSTimer			*_progressTimer;
	NSTimer 		*_reportViewsTimer;
}

- (id)initWithFrame:(CGRect)frame {
	self = [super initWithFrame:frame];
	if(self){
		self.userInteractionEnabled = YES;
//		self.backgroundColor = [UIColor redColor];

		[self initUI];

		[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(notificationWebSocketDidReceiveMessage:) name:WebSocketMgrNotificationDidReceiveMessage object:nil];
		[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(notificationMusicPlayerMgrDidPlay:) name:MusicPlayerMgrNotificationDidPlay object:nil];
		[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(notificationMusicPlayerMgrDidPause:) name:MusicPlayerMgrNotificationDidPause object:nil];
		[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(notificationMusicPlayerMgrCompletion:) name:MusicPlayerMgrNotificationCompletion object:nil];
}

	return self;
}

- (void)dealloc {
	[[NSNotificationCenter defaultCenter] removeObserver:self name:WebSocketMgrNotificationDidReceiveMessage object:nil];	
	[[NSNotificationCenter defaultCenter] removeObserver:self name:MusicPlayerMgrNotificationDidPlay object:nil];
	[[NSNotificationCenter defaultCenter] removeObserver:self name:MusicPlayerMgrNotificationDidPause object:nil];
	[[NSNotificationCenter defaultCenter] removeObserver:self name:MusicPlayerMgrNotificationCompletion object:nil];
}

- (void)initUI {
	_loopPlayerView = [[LoopPlayerView alloc] initWithFrame:CGRectMake(0, kPlayerMarginTop, self.frame.size.width, kPlayerHeight)];
	_loopPlayerView.loopPlayerViewDelegate = self;
	[self addSubview:_loopPlayerView];

	_favoriteButton = [[MIAButton alloc] initWithFrame:CGRectMake(self.bounds.size.width / 2 - kFavoriteWidth / 2,
																 self.bounds.size.height - kFavoriteMarginBottom - kFavoriteHeight,
																 kFavoriteWidth,
																 kFavoriteHeight)
										  titleString:nil
										   titleColor:nil
												 font:nil
											  logoImg:nil
									  backgroundImage:nil];
	[_favoriteButton setImage:[UIImage imageNamed:@"favorite_white"] forState:UIControlStateNormal];
	[_favoriteButton addTarget:self action:@selector(favoriteButtonAction:) forControlEvents:UIControlEventTouchUpInside];
	[self addSubview:_favoriteButton];

	[self initBottomView];
}

- (void)initBottomView {
	static const CGFloat kBottomViewHeight				= 35;
	static const CGFloat kBottomButtonMarginBottom		= 20;
	static const CGFloat kBottomButtonWidth				= 15;
	static const CGFloat kBottomButtonHeight			= 15;
	static const CGFloat kCommentImageMarginLeft		= 20;
	static const CGFloat kViewsImageMarginLeft			= 60;
	static const CGFloat kLocationImageMarginRight		= 1;
	static const CGFloat kLocationLabelMarginRight		= 20;
	static const CGFloat kLocationLabelWidth			= 80;

	static const CGFloat kCommentLabelMarginLeft		= 2;
	static const CGFloat kBottomLabelMarginBottom		= 20;
	static const CGFloat kBottomLabelHeight				= 15;
	static const CGFloat kCommentLabelWidth				= 20;

	static const CGFloat kViewsLabelMarginLeft			= 2;
	static const CGFloat kViewsLabelWidth				= 20;

	UIView *bottomView = [[UIView alloc] initWithFrame:CGRectMake(0, self.bounds.size.height - kBottomViewHeight, self.bounds.size.width, kBottomViewHeight)];
	//bottomView.backgroundColor = [UIColor redColor];
	UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(bottomViewTouchAction:)];
	[bottomView addGestureRecognizer:tap];
	[self addSubview:bottomView];

	UIImageView *commentsImageView = [[UIImageView alloc] initWithFrame:CGRectMake(kCommentImageMarginLeft,
																				   bottomView.bounds.size.height - kBottomButtonMarginBottom - kBottomButtonHeight,
																				   kBottomButtonWidth,
																				   kBottomButtonHeight)];
	[commentsImageView setImage:[UIImage imageNamed:@"comments"]];
	[bottomView addSubview:commentsImageView];

	_commentLabel = [[MIALabel alloc] initWithFrame:CGRectMake(kCommentImageMarginLeft + kBottomButtonWidth + kCommentLabelMarginLeft,
															  bottomView.bounds.size.height - kBottomLabelMarginBottom - kBottomLabelHeight,
															  kCommentLabelWidth,
															  kBottomLabelHeight)
											  text:@""
											  font:UIFontFromSize(8.0f)
										 textColor:[UIColor grayColor]
									 textAlignment:NSTextAlignmentLeft
									   numberLines:1];
	//commentLabel.backgroundColor = [UIColor redColor];
	[bottomView addSubview:_commentLabel];

	UIImageView *viewsImageView = [[UIImageView alloc] initWithFrame:CGRectMake(kViewsImageMarginLeft,
																				bottomView.bounds.size.height - kBottomButtonMarginBottom - kBottomButtonHeight,
																				kBottomButtonWidth,
																				kBottomButtonHeight)];
	[viewsImageView setImage:[UIImage imageNamed:@"views"]];
	[bottomView addSubview:viewsImageView];

	_viewsLabel = [[MIALabel alloc] initWithFrame:CGRectMake(kViewsImageMarginLeft + kBottomButtonWidth + kViewsLabelMarginLeft,
															bottomView.bounds.size.height - kBottomLabelMarginBottom - kBottomLabelHeight,
															kViewsLabelWidth,
															kBottomLabelHeight)
											text:@""
											font:UIFontFromSize(8.0f)
									   textColor:[UIColor grayColor]
								   textAlignment:NSTextAlignmentLeft
									 numberLines:1];
	//viewsLabel.backgroundColor = [UIColor redColor];
	[bottomView addSubview:_viewsLabel];

	UIImageView *locationImageView = [[UIImageView alloc] initWithFrame:CGRectMake(bottomView.bounds.size.width - kLocationLabelMarginRight - kLocationLabelWidth - kLocationImageMarginRight - kBottomButtonWidth,
																				   bottomView.bounds.size.height - kBottomButtonMarginBottom - kBottomButtonHeight,
																				   kBottomButtonWidth,
																				   kBottomButtonHeight)];
	[locationImageView setImage:[UIImage imageNamed:@"location"]];
	[bottomView addSubview:locationImageView];

	_locationLabel = [[MIALabel alloc] initWithFrame:CGRectMake(bottomView.bounds.size.width - kLocationLabelMarginRight - kLocationLabelWidth,
															   bottomView.bounds.size.height - kBottomLabelMarginBottom - kBottomLabelHeight,
															   kLocationLabelWidth,
															   kBottomLabelHeight)
											   text:@""
											   font:UIFontFromSize(8.0f)
									   textColor:[UIColor grayColor]
								   textAlignment:NSTextAlignmentLeft
									 numberLines:1];
	//locationLabel.backgroundColor = [UIColor redColor];
	[bottomView addSubview:_locationLabel];
}

- (void)loadShareList {
	_shareListMgr = [ShareListMgr initFromArchive];
	if ([_shareListMgr isNeedGetNearbyItems]) {
		_isLoading = YES;
	} else {
		[self reloadLoopPlayerData];
	}
}

- (void)reloadLoopPlayerData {
	ShareItem *currentItem = [_shareListMgr getCurrentItem];
	ShareItem *leftItem = [_shareListMgr getLeftItem];
	ShareItem *rightItem = [_shareListMgr getRightItem];

	[_loopPlayerView getCurrentPlayerView].shareItem = currentItem;
	[self playCurrentItem:currentItem];

	[_loopPlayerView getLeftPlayerView].shareItem = leftItem;
	[_loopPlayerView getRightPlayerView].shareItem = rightItem;
}

- (void)checkIsNeedToGetNewItems {
	if ([_shareListMgr isNeedGetNearbyItems]) {
		[self requestNewShares];
	}
}

- (ShareItem *)currentShareItem {
	return [[_loopPlayerView getCurrentPlayerView] shareItem];
}

- (void)playCurrentItem:(ShareItem *)item {
	[[_loopPlayerView getCurrentPlayerView] playMusic];
	[_radioViewDelegate radioViewStartPlayItem];

	[_reportViewsTimer invalidate];
	const NSTimeInterval kReportViewsTimeInterval = 15;
	_reportViewsTimer = [NSTimer scheduledTimerWithTimeInterval:kReportViewsTimeInterval
														 target:self
													   selector:@selector(reportViewsTimerAction)
													   userInfo:nil
														repeats:NO];

	[self updateStatusWithItem:item];
}

- (void)updateStatusWithItem:(ShareItem *)item {
	[_commentLabel setText: 0 == [item cComm] ? @"" : NSStringFromInt([item cComm])];
	[_viewsLabel setText: 0 == [item cView] ? @"" : NSStringFromInt([item cView])];
	[_locationLabel setText:[item sAddress]];
	[self updateShareButtonWithIsFavorite:item.favorite];
}

- (void)updateShareButtonWithIsFavorite:(BOOL)isFavorite {
	if (isFavorite) {
		[_favoriteButton setImage:[UIImage imageNamed:@"favorite_red"] forState:UIControlStateNormal];
	} else {
		[_favoriteButton setImage:[UIImage imageNamed:@"favorite_white"] forState:UIControlStateNormal];
	}
}

#pragma mark - Notification

-(void)notificationWebSocketDidReceiveMessage:(NSNotification *)notification {
	NSString *command = [notification userInfo][MiaAPIKey_ServerCommand];
	id ret = [notification userInfo][MiaAPIKey_Values][MiaAPIKey_Return];

//	NSLog(@"command:%@, ret:%d", command, [ret intValue]);

	if ([command isEqualToString:MiaAPICommand_User_PostInfectm]) {
		[self handleInfectMusicWitRet:[ret intValue] userInfo:[notification userInfo]];
	} else if ([command isEqualToString:MiaAPICommand_User_PostSkipm]) {
		[self handleSkipMusicWitRet:[ret intValue] userInfo:[notification userInfo]];
	} else if ([command isEqualToString:MiaAPICommand_User_PostFavorite]) {
		[self handleFavoriteWitRet:[ret intValue] userInfo:[notification userInfo]];
	} else if ([command isEqualToString:MiaAPICommand_User_PostViewm]) {
		[self handlePostViewmWitRet:[ret intValue] userInfo:[notification userInfo]];
	}
}

- (void)notificationMusicPlayerMgrDidPlay:(NSNotification *)notification {
	[_loopPlayerView notifyMusicPlayerMgrDidPlay];
}

- (void)notificationMusicPlayerMgrDidPause:(NSNotification *)notification {
	[_loopPlayerView notifyMusicPlayerMgrDidPause];
}

- (void)notificationMusicPlayerMgrCompletion:(NSNotification *)notification {
	NSLog(@"#swipe# completion");
	// æ­æ¾å®æèªå¨ä¸ä¸é¦ï¼ç¨å³è¾¹çå¡çæ¿æ¢å½åå¡çï¼å¹¶ç¨æ°å¡çå¡«åå³ä¾§çå¡ç

	// åæ­¢å½åï¼å¹¶æ è®°ä¸ºå·²è¯»ï¼æ£æ¥ä¸åå²è®°å½æ¯å¦è¶åºæå¤§ä¸ªæ°
	[[_loopPlayerView getCurrentPlayerView] pauseMusic];
	[_loopPlayerView getCurrentPlayerView].shareItem.unread = NO;
	[_shareListMgr checkHistoryItemsMaxCount];

	// ç¨å½åçå¡çåå®¹æ¿ä»£å·¦è¾¹çå¡çåå®¹
	[_loopPlayerView getLeftPlayerView].shareItem = [_loopPlayerView getCurrentPlayerView].shareItem;
	// ç¨å³è¾¹çå¡çåå®¹æ¿ä»£å½åçå¡çåå®¹
	[_loopPlayerView getCurrentPlayerView].shareItem = [_loopPlayerView getRightPlayerView].shareItem;

	// æ´æ°å³è¾¹çå¡çåå®¹
	if ([_shareListMgr cursorShiftRight]) {
		ShareItem *newItem = [_shareListMgr getRightItem];
		[_loopPlayerView getRightPlayerView].shareItem = newItem;

		// æ­æ¾å½åå¡çä¸çæ­æ²
		[self playCurrentItem:[_loopPlayerView getCurrentPlayerView].shareItem];

		// æ£æ¥æ¯å¦éè¦è·åæ°çæ°æ®
		[self checkIsNeedToGetNewItems];
	} else {
		NSLog(@"play completion failed.");
		// TODO è¿ç§æåµåºè¯¥ä»çé¢ä¸ç¦æ­¢ä»ç¿»é¡µ
	}
}

#pragma mark - received message from websocket

- (void)handleInfectMusicWitRet:(int)ret userInfo:(NSDictionary *) userInfo {
	if (0 == ret) {
		NSLog(@"report infect music successed.");
	} else {
		NSLog(@"report infect music failed.");
	}
}

- (void)handleSkipMusicWitRet:(int)ret userInfo:(NSDictionary *) userInfo {
	if (0 == ret) {
		NSLog(@"report skip music successed.");
	} else {
		NSLog(@"report skip music failed.");
	}
}

- (void)handleFavoriteWitRet:(int)ret userInfo:(NSDictionary *) userInfo {
	if (0 == ret) {
		id act = userInfo[MiaAPIKey_Values][@"act"];
		id sID = userInfo[MiaAPIKey_Values][@"id"];
		if ([[self currentShareItem].sID integerValue] == [sID intValue]) {
			[self currentShareItem].favorite = [act intValue];
			[self updateShareButtonWithIsFavorite:[self currentShareItem].favorite];
		}
	} else {
		NSLog(@"favorite music failed.");
	}
}

- (void)handlePostViewmWitRet:(int)ret userInfo:(NSDictionary *) userInfo {
	if (0 == ret) {
		[MiaAPIHelper getShareById:[[self currentShareItem] sID]
		 completeBlock:^(MiaRequestItem *requestItem, BOOL isSuccessed, NSDictionary *userInfo) {
			 [self handleGetSharemWitRet:isSuccessed userInfo:userInfo];
		 } timeoutBlock:^(MiaRequestItem *requestItem) {
			 NSLog(@"handleGetSharemWitRet failed.");
		 }];
	} else {
		NSLog(@"handlePostViewmWitRet failed.");
	}
}

- (void)handleGetSharemWitRet:(BOOL)isSuccessed userInfo:(NSDictionary *) userInfo {
	if (isSuccessed) {
		//"v":{"ret":0, "data":{"sID", "star": 1, "cComm":2, "cView": 2}}}
		NSString *sID = userInfo[MiaAPIKey_Values][@"data"][@"sID"];
		long start = [userInfo[MiaAPIKey_Values][@"data"][@"star"] intValue];
		id cComm = userInfo[MiaAPIKey_Values][@"data"][@"cComm"];
		id cView = userInfo[MiaAPIKey_Values][@"data"][@"cView"];

		ShareItem *currentItem = [_loopPlayerView getCurrentPlayerView].shareItem;
		if ([sID isEqualToString:currentItem.sID]) {
			currentItem.cComm = [cComm intValue];
			currentItem.cView = [cView intValue];
			currentItem.favorite = start;
			[self updateStatusWithItem:currentItem];
		}

		//NSLog(@"%@, %ld, %@, %@", sID, start, cComm, cView);
	} else {
		NSLog(@"handleGetSharemWitRet failed.");
	}
}

- (void)requestNewShares {
	const long kRequestItemCount = 10;
	[MiaAPIHelper getNearbyWithLatitude:[_radioViewDelegate radioViewCurrentCoordinate].latitude
							  longitude:[_radioViewDelegate radioViewCurrentCoordinate].longitude
								  start:1
								   item:kRequestItemCount
	 completeBlock:^(MiaRequestItem *requestItem, BOOL isSuccessed, NSDictionary *userInfo) {
		 NSArray *shareList = userInfo[@"v"][@"data"];
		 if (!shareList)
			 return;

		 [_shareListMgr addSharesWithArray:shareList];

		 if (_isLoading) {
			 [self reloadLoopPlayerData];
			 _isLoading = NO;
		 }
	 } timeoutBlock:^(MiaRequestItem *requestItem) {
		 NSLog(@"getNearbyWithLatitude timeout");
	 }];
}

#pragma mark - swip actions

- (void)spreadFeed {
	NSLog(@"#swipe# up spred");
	// ä¼ æ­åºå»ä¸éè¦åæ¢æ­æ²ï¼éè¦è®°å½ä¸ä¼ æ­çç¶æåä¸æ¥æå¡å¨
	[MiaAPIHelper InfectMusicWithLatitude:[_radioViewDelegate radioViewCurrentCoordinate].latitude
								longitude:[_radioViewDelegate radioViewCurrentCoordinate].longitude
								  address:[_radioViewDelegate radioViewCurrentAddress]
									 spID:[[self currentShareItem] spID]];
}

- (void)skipFeed {
	NSLog(@"#swipe# down");
	// åä¸æ»å¨ï¼ç¨å³è¾¹çå¡çæ¿æ¢å½åå¡çï¼å¹¶ç¨æ°å¡çå¡«åå³ä¾§çå¡çï¼èä¸ä¹åçæ­æ²éè¦ä»åè¡¨ä¸­å é¤

	// åæ­¢å½åï¼å¹¶æ è®°ä¸ºå·²è¯»ï¼æ£æ¥ä¸åå²è®°å½æ¯å¦è¶åºæå¤§ä¸ªæ°
	[[_loopPlayerView getCurrentPlayerView] stopMusic];
	[_loopPlayerView getCurrentPlayerView].shareItem.unread = NO;
	[_shareListMgr checkHistoryItemsMaxCount];

	// ç¨å³è¾¹çå¡çæ¿ä»£å½åå¡çåå®¹
	[_loopPlayerView getCurrentPlayerView].shareItem = [_loopPlayerView getRightPlayerView].shareItem;

	// å é¤å½åå¡çå¹¶æ´æ°å³ä¾§çå¡ç
	if ([_shareListMgr cursorShiftRightWithRemoveCurrent]) {
		ShareItem *newItem = [_shareListMgr getRightItem];
		[_loopPlayerView getRightPlayerView].shareItem = newItem;

		// æ­æ¾å½åå¡çä¸çæ­æ²
		[self playCurrentItem:[_loopPlayerView getCurrentPlayerView].shareItem];

		// æ£æ¥æ¯å¦éè¦è·åæ°çæ°æ®
		[self checkIsNeedToGetNewItems];

		[MiaAPIHelper SkipMusicWithLatitude:[_radioViewDelegate radioViewCurrentCoordinate].latitude
								  longitude:[_radioViewDelegate radioViewCurrentCoordinate].longitude
									address:[_radioViewDelegate radioViewCurrentAddress]
									   spID:[[self currentShareItem] spID]];
	} else {
		NSLog(@"skip feed failed.");
		// TODO è¿ç§æåµåºè¯¥ä»çé¢ä¸ç¦æ­¢ä»ç¿»é¡µ
	}
}

#pragma mark - LoopPlayerViewDelegate

- (void)notifySwipeLeft {
	NSLog(@"#swipe# left");
	// åå·¦æ»å¨ï¼å³ä¾§çå¡çéè¦è¡¥å

	// åæ­¢å½åï¼å¹¶æ è®°ä¸ºå·²è¯»ï¼æ£æ¥ä¸åå²è®°å½æ¯å¦è¶åºæå¤§ä¸ªæ°
	[[_loopPlayerView getLeftPlayerView] pauseMusic];
	[_loopPlayerView getLeftPlayerView].shareItem.unread = NO;
	// è¿ä¸å¥æ¯å¤ä½çï¼å ä¸ºshareItemæ¯å¯¹è±¡ï¼å¼ç¨ä¼ å¼ï¼
	// loopPlaerViewåshareListMgrçå¯¹è±¡æ¯åä¸ä¸ªï¼æ¹ä¸æ¬¡å°±å¯ä»¥äº
	//[shareListMgr getCurrentItem].unread = NO;
	[_shareListMgr checkHistoryItemsMaxCount];

	// è¡¥åä¸æ¡å³è¾¹çå¡ç
	if ([_shareListMgr cursorShiftRight]) {
		ShareItem *newItem = [_shareListMgr getRightItem];
		[_loopPlayerView getRightPlayerView].shareItem = newItem;

		// æ­æ¾å½åå¡çä¸çæ­æ²
		[self playCurrentItem:[_loopPlayerView getCurrentPlayerView].shareItem];

		// æ£æ¥æ¯å¦éè¦è·åæ°çæ°æ®
		[self checkIsNeedToGetNewItems];
	} else {
		NSLog(@"shift cursor to right failed.");
		// æ£æ¥æ¯å¦éè¦è·åæ°çæ°æ®
		[self checkIsNeedToGetNewItems];
		// TODO è¿ç§æåµåºè¯¥ä»çé¢ä¸ç¦æ­¢ä»ç¿»é¡µ
	}
}

- (void)notifySwipeRight {
	NSLog(@"#swipe# right");
	// åå³æ»å¨ï¼å·¦ä¾§çå¡çéè¦è¡¥å

	// åæ­¢å½åï¼è¿ä¸ªæ¹åçæ­æ²é½æ¯å·²è¯»çï¼æä»¥ä¸éè¦åæ è®°ä¸ºå·²è¯»
	[[_loopPlayerView getRightPlayerView] pauseMusic];

	// è¡¥åä¸æ¡å·¦è¾¹çå¡ç
	if ([_shareListMgr cursorShiftLeft]) {
		ShareItem *newItem = [_shareListMgr getLeftItem];
		[_loopPlayerView getLeftPlayerView].shareItem = newItem;

		// æ­æ¾å½åå¡çä¸çæ­æ²
		[self playCurrentItem:[_loopPlayerView getCurrentPlayerView].shareItem];

		// æ£æ¥æ¯å¦éè¦è·åæ°çæ°æ®
		[self checkIsNeedToGetNewItems];
	} else {
		NSLog(@"shift cursor to left failed.");
		// TODO è¿ç§æåµåºè¯¥ä»çé¢ä¸ç¦æ­¢ä»ç¿»é¡µ
	}
}

#pragma mark - Actions

- (void)favoriteButtonAction:(id)sender {
	if ([[UserSession standard] isLogined]) {
		NSLog(@"favorite to profile page.");

		[MiaAPIHelper favoriteMusicWithShareID:[self currentShareItem].sID isFavorite:![self currentShareItem].favorite];
	} else {
		[_radioViewDelegate radioViewShouldLogin];
	}
}

- (void)bottomViewTouchAction:(id)sender {
	NSLog(@"bottomViewTouchAction");
	[_radioViewDelegate radioViewDidTouchBottom];
}

- (void)reportViewsTimerAction {
	[MiaAPIHelper viewShareWithLatitude:[_radioViewDelegate radioViewCurrentCoordinate].latitude
							  longitude:[_radioViewDelegate radioViewCurrentCoordinate].longitude
								address:[_radioViewDelegate radioViewCurrentAddress]
								   spID:[[self currentShareItem] spID]];
}

@end
